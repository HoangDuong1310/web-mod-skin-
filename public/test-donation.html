<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Donation System - Ko-fi + VietQR</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            color: #28a745;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .result {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        .qr-container img {
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .bank-details {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test Donation System - Ko-fi + VietQR</h1>
        <p><strong>Server:</strong> <span id="serverStatus">ƒêang ki·ªÉm tra...</span></p>

        <!-- Test 1: Ko-fi Webhook Simulation -->
        <div class="test-section">
            <h2>üîî Test 1: Ko-fi Webhook Simulation</h2>
            <p>M√¥ ph·ªèng Ko-fi webhook ƒë·ªÉ test x·ª≠ l√Ω donation t·ª± ƒë·ªông</p>
            <button onclick="testKofiWebhook()">Test Ko-fi Webhook</button>
            <div id="kofiResult"></div>
        </div>

        <!-- Test 2: VietQR Bank Transfer -->
        <div class="test-section">
            <h2>üè¶ Test 2: VietQR Bank Transfer</h2>
            <p>Test t·∫°o QR code cho chuy·ªÉn kho·∫£n ng√¢n h√†ng Vi·ªát Nam</p>
            
            <label>S·ªë ti·ªÅn (USD):</label>
            <input type="number" id="vietqrAmount" value="5" min="0.01" step="0.01">
            
            <label>T√™n ng∆∞·ªùi donate:</label>
            <input type="text" id="vietqrDonor" value="Test Donor">
            
            <label>Tin nh·∫Øn:</label>
            <textarea id="vietqrMessage" rows="3">Test donation t·ª´ local development</textarea>
            
            <label>Ng√¢n h√†ng:</label>
            <select id="vietqrBank">
                <option value="970415">VietinBank</option>
                <option value="970407">Techcombank</option>
                <option value="970436">Vietcombank</option>
                <option value="970416">ACB</option>
                <option value="970403">Sacombank</option>
            </select>
            
            <button onclick="testVietQR()">T·∫°o VietQR</button>
            <div id="vietqrResult"></div>
        </div>

        <!-- Test 3: Manual Donation -->
        <div class="test-section">
            <h2>‚úã Test 3: Manual Donation</h2>
            <p>Test t·∫°o donation th·ªß c√¥ng qua API</p>
            
            <label>S·ªë ti·ªÅn (USD):</label>
            <input type="number" id="manualAmount" value="10" min="0.01" step="0.01">
            
            <label>T√™n ng∆∞·ªùi donate:</label>
            <input type="text" id="manualDonor" value="Manual Test Donor">
            
            <label>Email:</label>
            <input type="email" id="manualEmail" value="test@example.com">
            
            <label>Tin nh·∫Øn:</label>
            <textarea id="manualMessage" rows="3">Test manual donation</textarea>
            
            <label>Anonymous:</label>
            <input type="checkbox" id="manualAnonymous">
            
            <button onclick="testManualDonation()">T·∫°o Manual Donation</button>
            <div id="manualResult"></div>
        </div>

        <!-- Test 4: Admin Settings -->
        <div class="test-section">
            <h2>‚öôÔ∏è Test 4: Admin Settings</h2>
            <p>Test API qu·∫£n l√Ω c√†i ƒë·∫∑t donation</p>
            <button onclick="testGetSettings()">L·∫•y Settings</button>
            <button onclick="testUpdateSettings()">Update Settings</button>
            <div id="settingsResult"></div>
        </div>

        <!-- Test 5: Donation List -->
        <div class="test-section">
            <h2>üìã Test 5: Donation List</h2>
            <p>Test API l·∫•y danh s√°ch donations</p>
            <button onclick="testGetDonations()">L·∫•y Danh S√°ch Donations</button>
            <div id="donationsResult"></div>
        </div>
    </div>

    <script>
        // Ki·ªÉm tra server status
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/health');
                document.getElementById('serverStatus').innerHTML = 
                    response.ok ? '‚úÖ Online' : '‚ùå Error';
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = '‚ùå Offline';
            }
        }

        // Test Ko-fi Webhook
        async function testKofiWebhook() {
            const resultDiv = document.getElementById('kofiResult');
            resultDiv.innerHTML = '<p>ƒêang test Ko-fi webhook...</p>';

            const kofiData = {
                verification_token: "b97cdb98-4087-41d5-b0f9-94bb23bcfdc6",
                message_id: "test_" + Date.now(),
                timestamp: new Date().toISOString(),
                type: "Donation",
                is_public: true,
                from_name: "Test Donor Local",
                message: "Test donation t·ª´ local development",
                amount: "5.00",
                url: "https://ko-fi.com/test",
                email: "testdonor@example.com",
                currency: "USD",
                is_subscription_payment: false,
                is_first_subscription_payment: false,
                kofi_transaction_id: "test_kofi_" + Date.now()
            };

            try {
                const response = await fetch('/api/webhooks/kofi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(kofiData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Ko-fi webhook test th√†nh c√¥ng!</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Test VietQR
        async function testVietQR() {
            const resultDiv = document.getElementById('vietqrResult');
            resultDiv.innerHTML = '<p>ƒêang t·∫°o VietQR...</p>';

            const donationData = {
                amount: parseFloat(document.getElementById('vietqrAmount').value),
                currency: 'USD',
                paymentMethod: 'BANK_TRANSFER',
                donorName: document.getElementById('vietqrDonor').value,
                message: document.getElementById('vietqrMessage').value,
                isAnonymous: false,
                bankConfig: {
                    bankId: document.getElementById('vietqrBank').value,
                    accountNo: '113366668888',
                    accountName: 'WebModSkin Test Donation'
                }
            };

            try {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(donationData)
                });

                const result = await response.json();
                
                if (response.ok && result.qrData) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ VietQR t·∫°o th√†nh c√¥ng!</div>
                        <div class="qr-container">
                            <h3>QR Code ƒë·ªÉ chuy·ªÉn kho·∫£n:</h3>
                            <img src="${result.qrData.qrUrl}" alt="VietQR Code">
                        </div>
                        <div class="bank-details">
                            <h4>Th√¥ng tin chuy·ªÉn kho·∫£n:</h4>
                            <p><strong>Ng√¢n h√†ng:</strong> ${result.qrData.displayInfo.bankName}</p>
                            <p><strong>S·ªë t√†i kho·∫£n:</strong> ${result.qrData.displayInfo.accountNo}</p>
                            <p><strong>T√™n t√†i kho·∫£n:</strong> ${result.qrData.displayInfo.accountName}</p>
                            <p><strong>S·ªë ti·ªÅn:</strong> ${result.qrData.displayInfo.vndAmount} (${result.qrData.displayInfo.usdAmount})</p>
                            <p><strong>N·ªôi dung:</strong> ${result.qrData.transferNote}</p>
                        </div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Test Manual Donation
        async function testManualDonation() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.innerHTML = '<p>ƒêang t·∫°o manual donation...</p>';

            const donationData = {
                amount: parseFloat(document.getElementById('manualAmount').value),
                currency: 'USD',
                paymentMethod: 'MANUAL',
                donorName: document.getElementById('manualDonor').value,
                donorEmail: document.getElementById('manualEmail').value,
                message: document.getElementById('manualMessage').value,
                isAnonymous: document.getElementById('manualAnonymous').checked
            };

            try {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(donationData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Manual donation t·∫°o th√†nh c√¥ng!</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Test Get Settings
        async function testGetSettings() {
            const resultDiv = document.getElementById('settingsResult');
            resultDiv.innerHTML = '<p>ƒêang l·∫•y settings...</p>';

            try {
                const response = await fetch('/api/admin/donation-settings');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ L·∫•y settings th√†nh c√¥ng!</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Test Update Settings
        async function testUpdateSettings() {
            const resultDiv = document.getElementById('settingsResult');
            resultDiv.innerHTML = '<p>ƒêang update settings...</p>';

            const settings = {
                kofiUsername: 'webmodskin_test',
                kofiEnabled: true,
                vietqrBankId: '970415',
                vietqrAccountNo: '113366668888',
                vietqrAccountName: 'WebModSkin Test Donation',
                vietqrEnabled: true,
                donationsEnabled: true,
                usdToVndRate: 27000
            };

            try {
                const response = await fetch('/api/admin/donation-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Update settings th√†nh c√¥ng!</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Test Get Donations
        async function testGetDonations() {
            const resultDiv = document.getElementById('donationsResult');
            resultDiv.innerHTML = '<p>ƒêang l·∫•y danh s√°ch donations...</p>';

            try {
                const response = await fetch('/api/donations?page=1&limit=5');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ L·∫•y danh s√°ch donations th√†nh c√¥ng!</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå L·ªói: ${result.error}</div>
                        <div class="result">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Network error: ${error.message}</div>
                `;
            }
        }

        // Ki·ªÉm tra server khi load trang
        checkServerStatus();
    </script>
</body>
</html>
